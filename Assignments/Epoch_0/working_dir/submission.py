#!/usr/bin/python3

import json
from enum import Enum
from typing import Dict, List

# valid IOC types
class IOC(Enum):
    sha256 = "sha256"
    imphash = "imphash"
    domain = "domain"
    URL = "URL"
    IP = "IP"
    file_name = "file_name"
    scheduled_task = "scheduled_task"
    run_key = "run_key"
    DLL = "DLL"
    DLL_exported_function = "DLL_exported_function"
    PE_string = "PE_string"
    mutex = "mutex"
    named_pipe = "named_pipe"

# valid Malware types
class Malware(Enum):
    ransomware = "ransomware"
    scareware_trolling = "scareware/trolling"
    dropper = "dropper"
    loader = "loader"
    worm = "worm"
    stealer = "stealer"
    spyware = "spyware"
    root_kit = "root_kit"
    reverse_shell = "reverse_shell"
    remote_access_trojan = "remote_access_trojan"
    crypto_miner = "crypto_miner"
    wiper = "wiper"
    adware = "adware"
    generic_hackingtool = "generic/hackingtool"

# mitre tactics 
class MITRE_TACTIC(Enum):
    IMPACT = "TA0040"
    EXECUTION = "TA0002"
    PERSISTENCE = "TA0003"
    DISCOVERY = "TA0007"
    DEFENSE = "TA0005"
    C2 = "TA0011"
    
# mitre tactic techniques 
class IMPACT_TECHNIQUES(Enum):
    RESRC_HIJACK = "T1496"
    DEFACE =  "T1491"
    DATA_MANI = "T1565"

class EXECUTION(Enum):
    NATIVE_API = "T1106"
    SCHED_JOB = "T1053"
    SCRIPT_INTR = 'T1059' # command and scripting interpreter 
    WIN_MANAGE = 'T1047' 
    
class C2(Enum):
    DATA_ENC = "T1132"
    DATA_OBFS = "T1001" # data obfuscation
    NON_APP_PROTOCOL = "T1095" # non-application layer protocol (using SOCKS)?
    NON_STANDARD_PORT = "T1571"
    
class DISCOVERY(Enum):
    SYS_OWNER_USR = 'T1033'
    PERMISSION_GRS = 'T1069'
    NET_CONF = 'T1016'
    ACCOUNT = 'T1087'
    SOFTWARE = 'T1518'
    SYS_INFO = 'T1082'

class DEFENSE_EVASION(Enum):
    HIDE_ARTIFACTS = 'T1564'
    OBFS_INFO = 'T1027' # hiding exes inside section data
    
# binary analysis submission template keys
BIN_NAME = "binary_name"
SHA_HASH = "sha256"
IMPHASH = "imphash"
ARCH = "arch"
COMP_TIME = "compile_time"
STRS = "strings"
IMPORTS = "imports"
IOCS = "iocs"
MITRE_ATTACK = "mitre_att&ck"
MALWARE_VERDICT = "verdict"
MALWARE_CLASS = "classification"
VERDICT_NOTE = "verdict_justification"

# template keys for ioc analysis
IOC_TYPE = "type"
IOC_VAL = "Value"
IOC_NOTES = "Comments"

# keys for mitre analysis
MITRE_TECHS = "Techniques"
COMMENTS = "Comments"

# binary analysis template
{
    BIN_NAME: "",
    SHA_HASH: "", 
    IMPHASH: "", 
    ARCH: 0,
    COMP_TIME: 0,
    
    STRS: [
        
    ],
    
    IMPORTS: {
        
    },
    
    IOCS: [
        
    ],
    
    MITRE_ATTACK: {
        
    },
    
    MALWARE_VERDICT: None,
    MALWARE_CLASS: None,
    VERDICT_NOTE: ""
}

# IOC analysis template
{
    IOC_TYPE: IOC.file_name.value,
    IOC_VAL: "punish.exe",
    IOC_NOTES: "inherently sounds malicious"
}

# MITRE analysis template 
{
        
        MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                
            ],
            COMMENTS: ""
        },
}

# sus0 analysis --------------------------------------------------------------
CS_AO440 = {
    BIN_NAME: "CS_ao440.docx.exe",
    SHA_HASH: "a6cf39332dd2dc7e9186698d13c080993087e4954fb3f7aa571536050cd21827", 
    IMPHASH: "0c4b8853f78d34c6cf591e771fb41d11", 
    ARCH: 64,
    COMP_TIME: 1707106079,
    
    STRS: [
        "C:\\malware\\ch0nky.txt",
        "To find a version that can, check with the publisher!",
        "This App cannot run on your PC",
        "https://objection.smoothlawyerbrain.com/index.php",
        "FreeCandy.exe",
        "FLAG{IAmNotALawyerNorAmIYourLawyer}",
        "Please delete the corrupted document",
        "Error, This document is corrupted",
        "DEBUG: Make sure console is hidden. I am very 1337.",
        "DEBUG: obfuscate entrypoint"
    ],
    
    IMPORTS:  {
        "KERNEL32.dll": [
            "CreateProcessW",
            "FreeConsole",
            "GetFileAttributesA",
            "GetStartupInfoA",
            "GetTempPathW",
            "Sleep"
        ],
        "SHLWAPI.dll": [
            "PathCombineW"
        ],
        "WININET.dll": [
            "DeleteUrlCacheEntryW"
        ],
        "urlmon.dll": [
            "URLDownloadToFileW",
            "UrlMkSetSessionOption"
        ]
    },
    
    IOCS: [
        {
            IOC_TYPE: IOC.domain.value,
            IOC_VAL: "https://objection.smoothlawyerbrain.com/index.php",
        },
        {
            IOC_TYPE: IOC.file_name.value,
            IOC_VAL: "FreeCandy.exe",
        },
        {
            IOC_TYPE: IOC.PE_string.value,
            IOC_VAL: "Please delete the corrupted document",
        },
        {
            IOC_TYPE: IOC.PE_string.value,
            IOC_VAL: "Error, This document is corrupted",
        },
        {
            IOC_TYPE: IOC.DLL_exported_function.value,
            IOC_VAL: "URLDownloadToFileW",
        },
        {
            IOC_TYPE: IOC.DLL_exported_function.value,
            IOC_VAL: "CreateProcessW",
        }
    ],
    
    MITRE_ATTACK: {
                
        MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.DATA_MANI.value
            ],
        },
        
        MITRE_TACTIC.EXECUTION.value : {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value
            ],
        },
        
        MITRE_TACTIC.DEFENSE.value : {
            MITRE_TECHS: [
                DEFENSE_EVASION.HIDE_ARTIFACTS.value
            ],
        }
    },
    
    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.dropper.value,
    VERDICT_NOTE: "loads and runs FreeCandy.exe"
}

FREE_CANDY = {
    BIN_NAME: "FreeCandy.exe",
    SHA_HASH: "a6cf39332dd2dc7e9186698d13c080993087e4954fb3f7aa571536050cd21827", 
    IMPHASH: "177a919d405e1336d14e4aeaedec2ebd", 
    ARCH: 64,
    COMP_TIME: 1707106079,
    
    STRS: [
        "C:\\malware\\ch0nky.txt",
        "To find a version that can, check with the publisher!",
        "This App cannot run on your PC",
        "Legit error!",
        "Sorry, this application is not compatable with your system. Please try reinstalling.",
        "Unknown error"
    ],
    
    IMPORTS: {
        "KERNEL32.dll": [
            "FreeConsole",
            "GetFileAttributesA",
            "GetProcAddress",
            "GetStartupInfoA",
            "GetTempPathA",
            "LoadLibraryA",
            "Sleep",
        ],
        "SHLWAPI.dll": [
            "PathCombineA"
        ],
        "USER32.dll": [
            "MessageBoxA"
        ]
    },
    
    IOCS: [],
    
    MITRE_ATTACK: {
        
        MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.DATA_MANI.value
            ]
        },
        
        MITRE_TACTIC.EXECUTION.value : {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value
            ]
        },
        
        MITRE_TACTIC.DEFENSE.value : {
            MITRE_TECHS: [
                DEFENSE_EVASION.OBFS_INFO.value, # implicitly explicitly loading wininet.dll
                DEFENSE_EVASION.HIDE_ARTIFACTS.value
            ],
            COMMENTS: "hidden loading of wininet.dll"
        },
    },
    
    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.dropper.value,
    VERDICT_NOTE: "loads and runs login.php"
}

LOGIN_PHP = {
    BIN_NAME: "login.php",
    SHA_HASH: "963e9c518b305fe421a8154419ab5b5b6da6c22bd843f9306811610dbed969f2", 
    IMPHASH: "f9d798f6aefdbee078c40c74bb58c277", 
    ARCH: 64,
    COMP_TIME: 1707106150,
    
    STRS: [
        "C:\\malware\\ch0nky.txt",
        "To find a version that can, check with the publisher!",
        "This App cannot run on your PC",
        "No shot buddy",
        "You should probably just give up",
        "It only gets worse.",
        "Don't you have plans tonight? Just give up",
        "Do you really think this is going to work out in your favor?",
        "Bruh, go outside or something"
    ],
    
    IMPORTS:  {
        "KERNEL32.dll": [
            "CreateProcessA",
            "CreateThread",
            "FreeConsole",
            "GetFileAttributesA",
            "GetStartupInfoA",
            "Sleep",
            "VirtualProtect",
            "WaitForSingleObject"
        ],
        
        "USER32.dll": [
            "MessageBoxA"
        ],
        
        "WS2_32.dll": [
            "WSACleanup",
            "WSAConnect",
            "WSASocketA",
            "WSAStartup",
            "closesocket",
            "htons",
            "inet_addr",
            "recv",
            "send"
        ]
    },
    
    IOCS: [
        {
            IOC_TYPE: IOC.DLL.value,
            IOC_VAL: "WS2_32.dll",
            IOC_NOTES: "socket connections being made"
        },
        {
            IOC_TYPE: IOC.DLL_exported_function.value,
            IOC_VAL: "recv",
            IOC_NOTES: "recieving data from an external source"
        },
        {
            IOC_TYPE: IOC.DLL_exported_function.value,
            IOC_VAL: "send",
            IOC_NOTES: "sending data to an external source"
        },
        {
            IOC_TYPE: IOC.IP.value,
            IOC_VAL: "64.225.20.220"
        }
    ],
    
    MITRE_ATTACK: {        
        MITRE_TACTIC.EXECUTION.value: {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value,
            ],
        },
        
        MITRE_TACTIC.DEFENSE.value: {
            MITRE_TECHS: [
                DEFENSE_EVASION.HIDE_ARTIFACTS.value, # FreeConsole
            ],
        },
        
        MITRE_TACTIC.IMPACT.value: {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.DATA_MANI.value, # writing files 
            ],
            
            COMMENTS: "for the files written to disk after the reverse shell is executed"
        }
    },
    
    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.reverse_shell.value,
    VERDICT_NOTE: "connects to C2 server and executes recieved powershell commands"
}

CATS_EXE = {
    BIN_NAME: "cats.exe",
    SHA_HASH: "4d4dcbdb5d78a86dd64af071028ddd6ccfe0c63efb06f371296cb0d456411a18", 
    IMPHASH: "65ddb4541c9f26760eda3491415f9bb6", 
    ARCH: 64,
    COMP_TIME: 1707106327,
    
    STRS: [
        "FLAG{WhosReady4S0m3ScheduledMemez?}",
        "schtasks.exe",
        "Ran schtasks.exe %s",
        "Error openining file: %d",
        "Wrote %d bytes to %s",
        "meow.exe",
        "Logfile%d",
        "FLAG{MEOWMEOWMEOWMEOWForeverAndEver100YearsMeow}",
        "THIS IS YOUR LIFE NOW",
        "NEVER ENDING NYAN CAT",
    ],
    
    IMPORTS: {
        "KERNEL32.dll": [
            "CreateFileA",
            "Sleep",
            "WriteFile"
        ],

        "SHELL32.dll": [
            "ShellExecuteA"
        ],

        "SHLWAPI.dll": [
            "PathCombineA"
        ]
    },
    
    IOCS: [ 
        {
            IOC_TYPE: IOC.PE_string.value,
            IOC_VAL: "Ran schtasks.exe %s",
            IOC_NOTES: "indicates task scheduling"
        },
        {
            IOC_TYPE: IOC.PE_string.value,
            IOC_VAL: "Wrote %d bytes to %s",
            IOC_NOTES: "integrity of user files may be compromised"
        }
        
    ],
    
    MITRE_ATTACK: {        
        MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.DATA_MANI.value
            ],
            
            COMMENTS: "writes meow.exe to disk"
        },
        
        MITRE_TACTIC.EXECUTION.value : {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value, 
                EXECUTION.SCHED_JOB.value,
            ],
            
            COMMENTS: "schedules meow.exe to run every 5 minutes"
        },
        
        MITRE_TACTIC.DEFENSE.value : {
            MITRE_TECHS: [
                DEFENSE_EVASION.OBFS_INFO.value
            ],
            
            COMMENTS: "stores PE inside sections"
        }
    },
    
    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.loader.value,
    VERDICT_NOTE: "loads and runs meow.exe"
}

MEOW_EXE = {
    BIN_NAME: "meow.exe",
    SHA_HASH: "2bd17478a0775fec358ac1336c4fb448a36fce817a5129c84e74bd1fee9978e4", 
    IMPHASH: "efda1e276b31915712b8de9570ec36fc", 
    ARCH: 64,
    COMP_TIME: 1707106228,
    
    STRS: [
        "FLAG{MEOWMEOWMEOWMEOWForeverAndEver100YearsMeow}",
        "THIS IS YOUR LIFE NOW",
        "NEVER ENDING NYAN CAT"
    ],
    
    IMPORTS: {
        "KERNEL32.dll": [
            "FreeConsole",
            "GetStartupInfoA",
            "Sleep"
        ],

        "USER32.dll": [
            "MessageBoxA"
        ],

        "WINMM.dll": [
            "PlaySoundA"
        ]
    },
    
    IOCS: [ ],
    
    MITRE_ATTACK: {
         MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.DEFACE.value
            ],
        },
         
        MITRE_TACTIC.EXECUTION.value : {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value
            ],
        }
    },
    
    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.scareware_trolling.value,
    VERDICT_NOTE: "launches auditory meme until window is exited"
}

PUNISH_EXE = {
    BIN_NAME: "punish.exe", 
    SHA_HASH: "c13b7e338053260d8c8e877a0c57a74dd80892fd2a72560987bdd57d877fc1cc",
    IMPHASH: "31976634ff748ddc49f54278185397e1",
    ARCH: 64,
    COMP_TIME: 1707106151,
    
    STRS: [
        # strings associated with malware's check for the
        # `ch0nky.txt file before running`
        "To find a version that can, check with the publisher!",    
        "This App cannot run on your PC",
        "C:\\malware\\ch0nky.txt",
        # not sure if these count
        "Warning",
        "Are you sure you want to run the final payload? Warnining, if you are Photosensitive, do not run this. Are you sure you want to run ? Yes to continue, no/cancel to exit.",
        # indicate the .exe does something with sound
        "Music is done!"
    ],
    
    IMPORTS: {
        
        "GDI32.dll": [
            "BitBlt",
            "StretchBlt"
        ],
        
        "KERNEL32.dll": [
            "Beep",
            "FreeConsole",  # attempt to obfiscate 
            
            # indicators of running multiple concurrent threads
            "CreateThread",
            "ExitProcess",
            "FindResourceA",
            "GetCurrentThreadId",
            "GetFileAttributesA",
            "GetLastError",
            "GetModuleHandleA",
            "GetStartupInfoA",
            "LoadResource",
            "LockResource",
            "SizeofResource",
            "WaitForMultipleObjects",
            "WaitForSingleObject",
            
            "Sleep",
        ],
        
        "USER32.dll": [
            "DrawIcon",
            "GetCursorPos",
            "GetDesktopWindow",
            "GetSystemMetrics",
            "GetWindowDC",
            "GetWindowRect",
            "LoadIconA",
            "MessageBoxA",
            "MessageBoxW",
            "ReleaseDC",
            "SetCursorPos",
            
            # someone is monitoring something?
            "CallNextHookEx",
            "SetWindowsHookExA",
            "UnhookWindowsHookEx"
        ],
        
        "WINMM.dll": [
            "PlaySoundA"
        ]
    },

    IOCS: [
      {
          IOC_TYPE: IOC.file_name.value,
          IOC_VAL: "punish.exe",
          IOC_NOTES: "inherently sounds malicious"
      },
    ],

    MITRE_ATTACK: {
        
        MITRE_TACTIC.IMPACT.value : {
            MITRE_TECHS: [
                IMPACT_TECHNIQUES.RESRC_HIJACK.value,
                IMPACT_TECHNIQUES.DEFACE.value
            ],
            COMMENTS: "user is unable to clearly use their computer while their screen and mouse pointer are being randomly distorted. as the exectauble runs in a while loop, this makes the computers resources largely unusable until the program is stopped"
        },
        
        MITRE_TACTIC.EXECUTION.value: {
            MITRE_TECHS: [
                EXECUTION.NATIVE_API.value 
            ]
        },
        
        MITRE_TACTIC.DEFENSE.value: {
            MITRE_TECHS: [
                DEFENSE_EVASION.HIDE_ARTIFACTS.value
            ]
        }
    },

    MALWARE_VERDICT: True,
    MALWARE_CLASS: Malware.scareware_trolling.value,
    VERDICT_NOTE: "endlessly spams the users computer screen with visual and auditory distortions"
}

# sus1 analysis --------------------------------------------------------------
CALC_EXE = {
    BIN_NAME: "calc.exe",
    SHA_HASH: "b183bd6414c5123465075d76d2413c999d569492fb543acbc29690b4b745bdf2", 
    IMPHASH: " ba072a972fe6c47c8cf7a0347bb0af7a", 
    ARCH: 64,
    COMP_TIME: 0,
    
    STRS: [
        
    ],
    
    IMPORTS: {
        
    },
    
    IOCS: [
        
    ],
    
    MITRE_ATTACK: {
        
    },
    
    MALWARE_VERDICT: False,
    MALWARE_CLASS: None,
    VERDICT_NOTE: "known calculator exe by Microsoft identified on VirusTotal"
}

# construct final template for submission -------------------------------------
# TODO run punish.exe and wireshark

FLAGS = [
    "FLAG{IAmNotALawyerNorAmIYourLawyer}", 
    "FLAG{TBHImplicitlyExplicitIsBetterThanImplicit}",
    "FLAG{W4tch0ut4Ch0nkyShell!}",
    "FLAG{WhosReady4S0m3ScheduledMemez?}",
    "FLAG{MEOWMEOWMEOWMEOWForeverAndEver100YearsMeow}"
]

C2S = [
    ["https://objection.smoothlawyerbrain.com/index.php", "64.225.20.220"]
]

BINARIES = [
    CS_AO440,
    FREE_CANDY,
    LOGIN_PHP,
    CATS_EXE,
    MEOW_EXE,
    PUNISH_EXE,
    CALC_EXE
]

submission_obj = {'binaries': BINARIES, 
                            'Flags': FLAGS,
                            'C2s': C2S}

with open('submission.json', 'w') as f:
    json.dump(submission_obj, f, indent=4)
