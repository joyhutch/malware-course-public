#!/usr/bin/python3

from analysis_tools.analysis_formatting.mitre_analysis import MitreTactic, Impact, Persistence, Defense, Discovery, Execution, C2
from analysis_tools.analysis_formatting.formatting_classes import IOC_types, Malware_types, IOC, BinAnalysis, EpochAssignment

ioc_types = IOC_types()
malware_types = Malware_types()
epoch1 = EpochAssignment("epoch1")

# FLAGS ------------------------------------------------------------------------
# in sus_exe string dump
epoch1.found_flag("FLAG{TodaysQuizWhyIsNotepadDoingNetworkIO}") 
# in StartExam string dump
epoch1.found_flag("FLAG{TotallyLegitMutex}")

# SUSPICIOUS.EPOCH1.EXE --------------------------------------------------------
sus_exe = BinAnalysis("suspicous.epoch1.exe")
sus_exe.set_arch(64)
sus_exe.set_comp_time("65d41e4e")
# no matches on virus total
sus_exe.set_sha256("4a548f161dfbda599686c15c56bd81eab176668cfab00bc31df31fe2032e8343") 
sus_exe.set_imphash("8ff386ea4029e407f75e80606cb72508")

sus_exe_imports = {
    "KERNEL32.dll": [
        "CloseHandle",
        "CreateProcessW",
        "CreateRemoteThread",
        "FreeConsole",
        "FreeLibrary",
        "GetFileAttributesA",
        "GetModuleHandleA",
        "GetProcAddress",
        "GetStartupInfoA",
        "GetTempPathW",
        "LoadLibraryW",
        "Sleep",
        "TlsGetValue",
        "VirtualAllocEx",
        "VirtualFreeEx",
        "VirtualProtect",
        "VirtualQuery",
        "WriteProcessMemory"
    ],
    "PSAPI.DLL": [
        "EnumProcessModules",
        "GetModuleFileNameExW"
    ],
    "SHLWAPI.dll": [
        "PathCombineW"
    ],
    "WININET.dll": [
        "DeleteUrlCacheEntryW"
    ],
    "urlmon.dll": [
        "URLDownloadToFileW",
        "UrlMkSetSessionOption"
    ]
}
sus_exe.set_sus_imports(sus_exe_imports)

sus_exe_strs = [
    "!This program cannot be run in DOS mode. $",
    "1337ch0nH",
    "ExamMonitor.dll",
    "https://exam.gradescopech0nky.com/StartExam",
    "StartExam",
    "FLAG{TodaysQuizWhyIsNotepadDoingNetworkIO}",
    "C:\\malware\\ch0nky.txt",
    "kernel32",
    "LoadLibraryW"
]
sus_exe.set_sus_strings(sus_exe_strs)

sus_exe.set_verdict(True)

sus_exe.set_malware_type(malware_types.dropper)
sus_exe.set_verdict_rationale("loads and runs StartExam") 
# TODO verify behavior

# sus_exe.add_ioc(IOC(ioc_types.DLL))
# TODO ioc analysis

# mitre analysis 
# TODO 
defense_evasion = Defense()
defense_evasion.add_used_technique(defense_evasion.hide_artifacts)
sus_exe.add_mitre_tactic(defense_evasion)


# EXAM MONITOR -----------------------------------------------------------------
exam_monitor = BinAnalysis("ExamMonitor.dll")
exam_monitor.set_arch(64)
exam_monitor.set_comp_time('65d41e61')
exam_monitor.set_sha256('7b445bf8e7e6d1b00d62a810b2462f426d8dde4ba01a8dff994ff24b1fe10212')
# no matches on virus total
exam_monitor.set_imphash('7130f486d66d68ca3145bd8bc1516d6b')
sus_start_exam_strs = [
    "notepad.H",
    "kernel32H",
    "IsDebuggH",
    "erPresenH",
    "l bug reI",
    "not enouI",
    "gh spaceH",
    "for forH",
    "mat expaI",
    "nsion (PI",
    "lease suI",
    "bmit fulH",
    "https://L)",
    "port at H",
    "gcc.gnu.H",
    "org/bugsH",
    "/): H",
    "l bug reH)",
    "bmit fulH",
    "https://H",
    "port at H",
    "org/bugsH",
    "gcc.gnu.H",
    "AUATH",
    "1337ch0nky",
    "auth=",
    "1337ch0nky",
    "&guid=",
    "&user=",
    "&computer=",
    "/register.php",
    "gradescopech0nky.com",
    "1337ch0nky",
    "/checkin.php",
    "<ch0nky>",
    "register",
    "execute",
    "no args",
    "inject",
    "Unknown command",
    "vector::_M_realloc_insert",
    "basic_string::_M_construct null not valid",
    "/c \\Windows\\system32\\schtasks.exe /create /tn \"",
    "WindwosUpdate",
    "\" /sc minute /mo 1 /tr 'rundll32.exe",
    "StartExam",
    "Authorization:",
    "Content-Type: application/x-www-form-urlencoded",
    "cannot create std::vector larger than max_size()",
    "vector::_M_default_append",
    "basic_string::_M_construct null not valid",
    "powershell.exe /c",
    "Buffer component: %s",
    "SOFTWARE\\Microsoft\\Cryptography",
    "MachineGuid",
    "Unknown",
    "FLAG{TotallyLegitMutex}",
    "C:\\malware\\ch0nky.txt",
    "Software\\Microsoft\\Windows\\CurrentVersion\\Run",
    "ch0nky",
    "cannot create std::vector larger than max_size()",
    "basic_string::_M_construct null not valid",
    "0123456789abcdef",
    "vector::_M_realloc_insert",
    "what():",
    "0123456789",
    "basic_string::_M_create",
    "backdoor.dll"
]
exam_monitor.add_sus_strings(sus_start_exam_strs)

# mitre analysis
# TODO
"""
DISCOVERY -------------------
Uses RegOpenKeyExA and RegQueryValueExA to access registry key associated with 
SOFTWARE\\Microsoft\\Cryptography using read/exe permissions and query the value for 'MachineGuid' 
GetComputerNameA
GetUserNameA

C2 -------------------
gradescopech0nky.com
port 443

call to WinHttpOpen
    pszAgentW -> 1337ch0nky
call to WinHttpConnect
    server name -> gradescopech0nky.com
    port num -> 443
call to WinHttpOpenRequest

uses Rc4 encryption 


"""

# add all analyzed binaries and prep submission
epoch1.add_binary_analysis(sus_exe)
epoch1.add_binary_analysis(exam_monitor)
epoch1.prepare_submission()