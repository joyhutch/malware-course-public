
   
![[Course_icon.png]]
# Designing Your Own Malware Analysis Lab
## Security Rant (Do not skip)

When analyzing or executing un-trusted code, it is wise to perform all work in an environment that is isolated from sensitive resources. In particular, it is strongly advised to conduct all research inside of a *sandbox*. A sandbox in the context of computer security is an environment that isolates resources from an executing program. 
When analyzing malware, you are strongly encouraged to use a sandbox that isolates malicious payloads from your file system, LAN, and the internet. This is to reduce the risk of accidentally infecting your computer or other devices.

An example sandbox that many of you have probably leveraged is found in Window's Antivirus engine. Windows by default will execute every un-trusted executable inside of a sandbox to dynamically detect malicious actions. If the executable was tested in the main environment, this could allow the code to tamper with system resources and defeats the purpose of anti-malware scanning. 

One strategy for creating a sandbox is to use Virtualization based isolation.  This involves using a *Hypervisor* to run a *Virtual Machine*.  Please read  the section on [[Virtualization]] if you have never used a Virtual Machine or Hypervisor before. 


A hypervisor is an emulator that allows you to run a *guest OS* inside of your *host OS*.  This class will directly support the use of the Virtualbox Hypervisor, but it is possible to use other including


- Hyper-V: OK 
	- If you have a pro version of windows, this will work fine but the vagrant script is not setup to work out of the box for hyper-v. 
- Vmware : OK 
	- If you have a license great! The vagrant script, however, is not setup to work for Vmware. You would need to make the changes yourself
- QEMU: OK
	- not recommended for Windows guest and is slow without hardware acceleration/virtualization 
- KVM : OK
- XEN: OK
	- probably the best isolation. I will not be able to help you if something breaks
- Paralells: No. 

# Installing Virtualbox and Vagrant

In this section, you will install [Virtualbox](https://www.virtualbox.org/). Optionally, you may install [Vagrant](https://www.vagrantup.com/) to automatically install and configure your development environment. I strongly encourage you to manually setup your development environment at least once. The vagrant script is here so that you can quickly deploy your environment if something goes wrong.  For more on what Vagrant is, please read the documentation on their website. 

Terminology reminder: a *hypervisor* allows a *host*, machine to run *guest* VMs.  Please follow the directions below based on your *host* OS. I.e., if your primary OS is Windows, follow the directions for Windows. 


## Windows  
You are welcome to visit the VirtualBox installation page but the directions provided will use the `choco` package manager.  
in a Boxstarter shell, an elevated powershell window,  run 
```powershell
# package is located here: https://community.chocolatey.org/packages/virtualbox
choco install virtualbox 
# optional 
choco install vagrant 
```

## MacOS
For MacOS, I strongly recommend installing the brew package manager if you haven't already. 
```bash
brew install --cask virtualbox
# optional 
brew install --cask vagrant
```

# Debian based Linux
(this includes Ubuntu, Mint, ...etc)
```bash
# install and auto agree 
sudo apt install -y virtualbox
# optional 
sudo apt install -y vagrant
```
# Other Linux
You can probably figure this out if you are running another distro of Linux :-)


# All
Now that you have Vagrant installed, run the following from a shell to install the vagrant reload-plugin. This is required for vagrant installations  
```bash
# optional
vagrant plugin install vagrant-reload
```


# Manual Malware Setup

This section will walk you through the steps to setup the course malware analysis lab. While you are not required to use this setup, all malware is guaranteed to work in this environment. Even if you plan on using Vagrant to automatically setup your environment, please read through these directions anyway.

# Configuring VMs
In order to create a safe environment for analyzing malware, it is essential to follow these directions exactly! Failure to do so could result in damage to your host. **You are responsible for any damage to your host that occurs as a result of failing to follow these directions. By continuing your enrollment in this class, you acknowledge that  you understand that this class will expose you to malware that can cause real damage. If you deviate from the provided directions, this could include your personal computer.  You agree to read, understand, and follow these directions in order to prevent such damage from ocurring**

Said differently, please read the directions very carefully. 

For this class, there will be three virtual machines: 
- Sandbox: a Windows sandbox machine. This is where you will detonate course malware.   
- Gateway: an Ubuntu Analysis and gateway box. This is where traffic will be routed to from the Sandbox
- Dev: a Windows development environment that you need to use for course assignments. 


This Windows sandbox VM will serve as the primary environment to detonate *untrusted code and suspected malware*. All execution of malicious code should be confined to this environment, and any deviation from this directive could result in damage to your host OS, and could lead to further infection. I also will probably yell at you for not following directions :-). 

The Gateway VM will be the gateway for the sandbox VM. In particular, the Gateway VM, after initial configuration, will not have direct network access. There will be a *virtual network* that routes all traffic from the Sandbox VM to the Gateway VM. This is to ensure that any code running on the sandbox is unable to tamper with analysis tools, and has a reduced risk of escaping to the open internet/LAN.


If you have enough space for three VMs,  it is advised to have two separate windows VMs. One for analysis of malware, and one for development of code. If you are unable to  run 3 VMs or do not have enough space, you *can* do all of your development on the Windows sandbox VM, but  this adds unnecessary risk. 

# Disclaimers: 
## Virtualization is not always enough
**Virtualization based isolation is not a fool proof solution**. Exploits for hypervisors exist, and if the malware is packaged with such an exploit they can escape the sandbox.   In particular, it is possible that the malware can detect that it is in a virtual environment, and  can escape either via a misconfiguration or exploitation. From there,  it can spread to the host OS.  This is rare in practice but not impossible.  This is  why when analyzing malware from a sophisticated actor, it is essential to do a clean install for each sample, and ensure the host and guest OS are NOT connected to the internet or any critical network via any communication channel (USB, bluetooth, ...etc). 

When analyzing crimeware, the setup used in this class should provide adequate guest isolation and is *probably* safe. That said, the course authors make no guarantees about the safety of the sandbox outside of the context of the class.  Failure to configure the sandbox correctly could result in the corruption of host resources.  Please read the following directions very carefully. If you find yourself analyzing sophisticated malware, please consult your organizations best practices.  Keep in mind that exploitation is not the only way to escape from a sandbox: if you misconfigure your VM, it can often be trivial. For example, if you enable bidirectional drag and drop, then you have effectively provided the sandbox unfettered access to your host computer. 

## Our sandbox is obviously a sandbox
The sandbox for this class takes no steps to hide its identity as a sandbox. It is obviously running VirtualBox, and has a suite of common analysis tools in the default location. For real world detonation at scale, it is necessary to take steps to configure the Windows VM to look more like a legitimate device. This will be explored towards the end of the course time permitting.  As a punchline though, in order to build a more stealthy sandbox, it is helpful to have access to the source code of the hypervisor so you can modify default values. For this case, Hyperdbg/customized KVM are good choices. In order to benchmark your sandbox, I would recommend using https://github.com/a0rtega/pafish.   This is a remark **and not requried for this course**. 


# Before you begin:
- Verify that you installed VirtualBox https://www.virtualbox.org/
- Read through https://www.oracle.com/technical-resources/articles/it-infrastructure/admin-manage-vbox-cli.html . If you have not used a virtual machine before, please DO NOT SKIP THIS. 
- If you want to automate the deployment, verify that you installed Vagrant https://www.vagrantup.com/downloads  
	- Again: I would recommend going through this process manually *at least once*. It is good practice.
	- Note, don't forget to add vagrant to your path
- Make sure you have git installed on your host Host OS. 
	- If you don't have git installed: see https://github.com/git-guides/install-git
	- If you haven't used git before: see https://github.com/git-guides 
- Open up a terminal and  clone the course git repository https://github.com/kbsec/CS-501-malware-course-public .


# Directions
For each section, follow the directions and leverage files contained inside of `LabSetup`

For each machine, there should be a Folder that contains the vagrant script and required shell/powershell scripts 

# VirtualBox network 
Before installing any virtual machines, if you aren't using Virtualbox, you should setup a virtual network. If you are using VirtualBox, this step is handled later. 

# Layout

![[lab-diagram-2.png]]


# Gateway
In this section, you will install and configure the analysis Gateway machine.
To do this, you need to 
1) install/import an Ubuntu 22.04 Server VM
2) Configure  a second network adapter on a private virtual network
3) Install required tools for the course
4) Setup the default behavior or Inetsim
6) Allow network connections from your Windows sandbox, thus, positioning the Gateway VM as the default gateway for the Sandbox VM (hence, why we will call it "Gateway"). 

- Visit the [Ubuntu releases page](https://releases.ubuntu.com/22.04/)  and download a Server ISO disk image. 
	- If you have never used VirtualBox before, I would check out this [video](https://www.youtube.com/watch?v=rJ9ysibH768)
	- Note you can also use download the Desktop ISO, but since the Vagrant automation uses a server image, it is likely better to use the server image.
	- Install the Ubuntu server using Virtualbox. If you are unsure how to do this, check out this [video](https://www.youtube.com/watch?v=vxb894qV7-8).  After following along in the video, you can skip to the `Gateway Virtual Network` section below.
	- Alternatively, you can download an OVA format vm from [here](https://cloud-images.ubuntu.com/releases/22.04/release/) and configure the server using  a seed.iso to set the login. This is left as an exercise :-).  
	- https://www.linuxvmimages.com/images/ubuntu-2204/ should also be fine, but I haven't tested it out myself. 
	- At the time of writing this guide, the most current appliance was [ubuntu-22.04-server-cloudimg-amd64.ova](https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.ova) but depending on when you setup your environment, you might need to adjust the OVA.  
	- To import an OVA using VBoxManage, run 
	
```bash
VBoxManage import --dry-run ubuntu-22.04-server-cloudimg-amd64.ova
``` 
and then based on those options import import the appliance. See https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/vboxmanage-import.html for more.  I ended up running ```
```bash
VBoxManage import ubuntu-22.04-server-cloudimg-amd64.ova  --vsys 0  --ostype "Ubuntu_64" -vmname "Gateway"
```

But again, I would recommend just installing the server manually.  

- If your Host OS is Windows, you can still import the Ubuntu OVA  into Virtualbox, but you will have to disable Hyper-V on your host OS. I personally don't like doing this because it prevents you from using WSL and disables virtualization based security/isolation on your host OS. I.e., lsass  no longer gets virtualization based security.
- If you want to keep Hyper-V enabled, you  should manually install Ubuntu. 
- For this course, you will need Inetsim, Wireshark, iptables, mitmproxy, Ghidra and PE-Bear.  

## Gateway Virtual Network

In this section, you will setup a virtual network that allows VMs to communicate with each other. This network will be isolated, and only VMs that are a part of the private network will be able to communicate. 
### Private Network 
- After installing Ubuntu 22.04 using Virtualbox, click settings, and go to Network. 
- Click on adapter 2 and then tick enable. You have just enabled a second network adapter. The first adapter should be set to NAT.
- In the second adapter, set "Attached to" -> Internal Network.   
Choose a name (I chose `PrivateNetwork` because I am creative) and click save.
- For the Vagrant, I chose `ch0nky` for reasons that will become apparent later :-)  
- Alternatively, use the CLI to add a network 
`
```bash 
VBoxManage modifyvm "Gateway" --nic2 intnet --intnet2 "ch0nk"
```
	- here we modify the vm named `Gateway` to modify its second Network adapter to be internal and named `ch0nky`. For more on how internal networks work, see https://www.nakivo.com/blog/virtualbox-network-setting-guide/

### Port Forwarding 
**If you used Vagrant, you can skip this step. **. It does it for you!


The next step for the gateway is to setup Guest-->Host port forwarding.  This will allow you to SSH to the Gateway server from the host server.
Go to the network settings and click on the first network adapter `NAT`.
- Click advanced and then Port Forwarding  
- Set the name of the rule  to whatever you want. I chose `ssh` because I am creative. 
- Next, set the protocol to `TCP`, the Host IP to `127.0.0.1`, the Host port to whatever you want.  I chose `2222` 
- The end result should look like this: 
- ![[port_forward_gateway.png]]
- You can also automate this using VBoxManage . Run `VBoxManage modifyvm "Gateway"`  To see the options for modifying a powered off VM. The relevant option for portforwarding is ``` [--natpf<1-N> [<rulename>],tcp|udp,[<hostip>],
                                          <hostport>,[<guestip>],<guestport>]
Hence, we run 
```bash
VBoxManage modifyvm "Gateway" --natpf1 "ssh,tcp,127.0.0.1,2222,,22"
```
( `--natpf1` --> `NAT Port Forward interface #1`)

### Booting up and Connecting 
- Once you have installed the OS, and setup a Port Forward rule,  boot up your VM. You can do this from a shell with 
```bash
VBoxManage startvm  "Gateway" 
```

or use the GUI and click the green start button. This will bring up Now login.  If you used Vagrant, the username/password is `vagrant:vagrant`.
- If you used a cloud image, enter the password you used in the seed.iso
- Otherwise, enter the username/password that you used when installing Ubuntu 22.04 from the server  installation media.
Verify that you can login and that you have sudo privileges  with 
```bash 
sudo whoami
```



You might have noticed that there is no copy and paste in the console window! To make our life easier, we will install OpenSSH on the Gateway server, and then connect to it from our host.

First, verify that this machine is internet connected. I like to use `ping 1.1.1.1` to verify connectivity but depending on your network, pings might be blocked.  Using an HTTP client and connecting to  `example.com` or any website should be sufficient.  If you are unable to connect to the internet, start by diagnosing the following: 
1) DNS: (`nslookup google.com` Does it work?)
2) Routing:  
```bash
nc example.com 80
GET / HTTP/1.0
```
3) DHCP Lease: `renew-dhcp`
4) Ensure your first Interface is set to NAT and your host machine has network access

If you still cannot connect to the internet, please see [[How to Ask for Help]]

Now that you have verified internet connection we will upgrade your machine and setup SSH. 
In a terminal on the Gateway VM, run the following (you can ignore lines with a hashtag: this is a comment) 
```bash
# update our package list
sudo apt update

# install updates
sudo apt upgrade -y

# install OpenSSH if we haven't already
sudo apt install -y openssh-server

# Enable SSH if we haven't already
sudo systemctl enable --now ssh
```

Next,  find the ipv4 address of your first  Ethernet network interface. It should be `eth0`.
Run 
```bash 
ip addr show eth0
```
On my machine, the result is 

```bash
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:dc:ee:4d brd ff:ff:ff:ff:ff:ff
    altname enp0s3
    inet 10.0.2.15/24 metric 100 brd 10.0.2.255 scope global dynamic eth0
       valid_lft 85899sec preferred_lft 85899sec
    inet6 fe80::a00:27ff:fedc:ee4d/64 scope link 
       valid_lft forever preferred_lft forever

```
The line with `inet` will display your IPV4 address. In the example above, the address is `10.0.2.15`. For the following steps, make sure to make the necessary changes if your IPV4 address is different!

Use a text editor to set ssh to bind to `10.0.2.15:22` by modifying `/etc/ssh/sshd_config` and changing the line with `#ListenAddress 0.0.0.0` to  `ListenAddress 10.0.2.15`. The reason for this, is to prevent machines on the Internal Network from being able to SSH into the Gateway.  If you have never used a terminal based text editor before, I recommend using `nano` because it is easy/intuitive. If you want to be more efficient, you can  also try your hand at using `vim`, but note that it is far less intuitive and takes significant time investment to learn.
For a brief tutorial on nano, see [here](https://linuxize.com/post/how-to-use-nano-text-editor/) but nothing beats the  [man](https://linux.die.net/man/1/nano) pages. You can also see this information by running 
```bash
man nano
```

Once you modify the configuration file, run the following:

```bash
# restart ssh 
sudo systemctl restart sshd
# make sure that the system service is running
systemctl status sshd
# Look for what process is listenining on port 22: which is where ssh-server listens by default.
sudo ss -tulnp | grep 22
```

Next, we will SSH into our gateway server from our host machine:
- If you are using Linux or MacOS, you should have an ssh client by default.  For 
- Windows users, I highly recommend installing [Windows terminal](https://apps.microsoft.com/store/detail/windows-terminal/9N0DX20HK701?hl=en-us&gl=us)
and executing the commands there.  Otherwise, you will need to use [putty](https://www.putty.org/). I do not recommend doing this, and will not support debugging issues related to putty.  Please: just use Windows terminal :-). 

If you have never used SSH before, please read through the basics [here](https://www.ssh.com/academy/ssh/protocol)

If you have never used a shell before, you might want to consider taking this course next year :-). I of course will not stop you, and will instead recommend you read through this [tutorial](https://towardsdatascience.com/basics-of-bash-for-beginners-92e53a4c117a). That said....

![[struggle_bus.png]]
Side affects of taking this course without the prerequisites may include 
- suffering
- having to work twice as hard on already difficult projects
- ridding the struggle bus 
- Spending hours debugging issues that could have taken 5 minutes

Experienced SSH might be thinking that using password based authentication is unsafe, and you would be correct. However, since we are mapping to the loopback address on our host, and restricting the SSH server to our NAT address, unless you are sharing your machine with other users at the same time, this setup is fine for now.

To connect to your machine, open a terminal on your host OS and run 
```bash
# make sure to replace <user> with the username you set 
# note that -p 2222 is the port we set for our port forwarding
# i.e., we map the guest:22 --> host:2222
ssh -p 2222 <user>@127.0.0.1 
```
You will get  a warning about the key fingerprint being unknown: type `yes` and hit enter. 
Finally, it should prompt you for a user password.  If all goes well, you should now have a shell to your Gateway VM! 

On your Host OS run the following command to generate an SSH key:
```bas
ssh-keygen -t ed25519 -C Gateway -f gateway
```
Feel free to add a passphrase to the key. You should see something like this followed by the random ascii art
```
Generating public/private ed25519 key pair.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in gateway
Your public key has been saved in gateway.pub
The key fingerprint is:
SHA256:9KQnfvCUwwi7TxE1hczIpHM5li4HDBJ0bX/Xyo5y5aE Gateway
```

You should now have 2 new files:
```bash
# your private key
gateway

# Your public key
gateway.pub
```
 Get the contents of the public key by running 
```bash
cat gateway.pub 
```

My public key, in this example, is `ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO3FK2VQNo4IeuW19gVwM0YwkO49nL28M6SX8boNLxcl Gateway`. Your's **will be different**. 

Inside of your SSH terminal for Gateway,  run 
```bash
PUBLIC_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIO3FK2VQNo4IeuW19gVwM0YwkO49nL28M6SX8boNLxcl Gateway"
# Append your public key to authorized keys file
echo $PUBLIC_KEY >> ~/.ssh/authorized_keys
```
This command will add your public key to the list of public keys that can be used (with a private key) to remotely access the server. You can now connect to the server using your private key as follows:
- open up a new terminal on your Host os
- Run the following command in the same directory as your ssh key. 
```bash
# connect to the server using your new ssh key
ssh -i gateway -p 2222 <user>@127.0.0.1
```

You can also add the following to your ssh_config file making sure to replace the User with the username. If you don't know what that is, read the documentation :-)
```bash
Host Gateway
  HostName 127.0.0.1
  User <user>
  Port 2222
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /path/to/private/key/gateway
  IdentitiesOnly yes
  LogLevel FATAL

```

You can now also disable password based authentication.

### Installing Necessary Tools 
Open up an SSH connection to the Gateway VM.  Start by installing a Desktop Environment by running the following. This will take some time. 
```bash
sudo apt-get install -y ubuntu-desktop --no-install-recommends
```

Note: for some installations of minimal desktop, that result in a terminal with double spaced fonts. To fix this, see [this link](https://linuxopsys.com/topics/change-terminal-font-size-in-ubuntu)


Now, locate the script `tools.sh` inside of the `Gateway` folder in `LabSetup`. I.e., `$COURSEHOME/LabSetup/Gateway/tools.sh` where `$COURSEHOME` is the absolute path to the cloned course repo. Please read through the script and understand all of the   commands being. Feel free to modify as needed. Now run the script on the Gateway VM using an ssh connection (You can copy and paste the contents).



### Ghidra
See directions here--> [[Ghidra Instalation]] Note that tools.sh does install Ghidra, but only for `Gateway`.  It also does not automatically enable Ghidrathon. If you figure out how to do this from a script, please let me know :-).


#### Guest Additions
If you want to have shared folders, clipboard access and the ability to resize your screen, you are going to need to install  VirtualBox Guest Additions. To do this, see the script `vbox_guestadditions.sh` inside of the `Gateway` folder in `LabSetup`. I.e., `$COURSEHOME/LabSetup/Gateway/vbox_guestadditions.sh` where `$COURSEHOME` is the absolute path to the cloned course repo. You 

## Gateway Network Configuration
At this point, you should have all of your tools installed. It is time to configure the network. Our plan is to position `Gateway` as (you guessed it!) the default gateway for our Windows Sandbox, and force all traffic through it. We can then choose whether or not to relay traffic to the open internet afterwards.
![[network.png]]

To accomplish this, we have two action items:
- 1) Modify the configuration for your second network adapter 
- 2) Modify the configuration for a tool called `inetsim`

For those who are not familiar with networking in Linux, please see this introduction: https://www.youtube.com/watch?v=Yr6qI6v1QCY (mostly the last section where he talks about netplan config)


open up a terminal and run 
```
sudo -i
```
to drop into a root shell . 

Verify that the there are 3  network interfaces: `lo, eth0 (enp0s3), eth1 (enp0s8)` . If you followed the directions up to this point, `eth0` should correspond to the NAT network and `eth1` should be the Internal Network.   

To verify which one actually corresponds to the internal network, disconnect the network adapter using the GUI or VBoxManage, and see if you can still connect to the internet. If you can, then you disabled the internal adapter.  You can view all network interfaces by running `ip a`
![[interfaces.png]]

From there, run the following to create a configuration file that sets your static IP on this interface
**Be sure to replace `eth1` with the name of your interface that corresponds to the private network!**
```bash
# this creates a new yaml file 
sudo cat >> /etc/netplan/malware-lab.yaml << EOL
network:
        version: 2
        renderer: networkd
        ethernets: 
                enp0s8: 
                        dhcp4: no
                        addresses: 
                                - 10.10.10.2/24
EOL
sudo netplan apply
```

Again: make sure to replace  `eth1` with whatever your new interface is called.
![[new_static_ip_10.10.10.2.png]]

Finally, run  `accept-all-ips start eth1` to allow traffic to the specified interface.  
- *Bonus*: look at how accept-all-ips works. Can you figure out how to perform the same action, except only allow traffic from `10.10.10.3` (the static IP of the Windows  malware sandbox)?

The configuration above is used to set a static IP address for our machine on the internal network.

## Configure Inetsim
Inetsim, as the name suggests, is a collection of tools to  run simulated network services  suspicious binaries to interact with.
- Make a copy of the inetsim configuration
- `cp /etc/inetsim/inetsim.conf ~/Desktop/my_inetsim.conf`
	- You can name it whatever you want, and place it anywhere you want. 
	Start up your favorite text editor and modify the following:
	
- enable the DNS server by un-commenting `start_service dns`
	- eg![[inetsim_service_dns.png]]
- In service bind address,  set `service_bind_address    10.10.10.2`
	-  eg ![[inetsim_bind_addr.png]]
- In dns_default_ip set `dns_default_ip          10.10.10.2`
- Add `start_service dummy_tcp` in the `# start_service` section
- To modify the port that dummy_tcp runs on, set `dummy_bind_port	1234` in the `# Service Dummy` section
- Finally, to run with our new configuration, run  `sudo inetsim --config=/path/to//my_inetsim.conf` 

If everything works, you should be able to  interact with the Inetsim services from both your Gateway VM and your Windows sandbox VM (once it is setup). To make sure it is working, run `curl http://10.10.10.2:80` and note the response body.  Also run `sudo ss -tulnp` to view information about processes binding on specific ports.

That's it for now on the Gateway side... we will configure more once we have the sandbox setup. 


# Windows Sandbox  Setup
Make sure your `Gateway` VM is running, and `inetsim` is running. 
Grab yourself a 90 day trial VM from Microsoft. 

## Enterprise with admin
https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise

## Home
https://www.microsoft.com/en-us/software-download/windows10ISO

You can also use a pre-configured one 
- `https://github.com/gusztavvargadr/packer` 
- https://www.microsoft.com/en-us/evalcenter/evaluate-windows-10-enterprise
	- Fill in fake information. No need to get spammed by Microsoft
	- From there, add the ISO to a new Windows VM and follow the directions to get set up. .
	

This section con be completed as either a single VM (don't do this please :-) ) or as two separate VMs.  By the end of this section, you should have a Development VM, and a sandbox VM.  First, we will setup the Windows Sandbox VM.


Add the downloaded ISO to the empty disk slot
![[vm_storage_empty.png]]
![[vm_storage_set.png]]

Afterwards, consider adding more CPU resources and video  memory (at least 128MB). Finally, click start. 
- On the boot screen, follow the directions to install. You don't need an office account. If it asks for one, click join domain.
- For Home edition, make sure to disconnect the network adapter to ensure there is no internet access.  This will allow you to install windows 10 without creating an account.
-  Skip the upgrade for now and click custom install 
-  This will take a bit.
- Once completed, re-enable the network adapter (nic1)
-  Just as in `Gateway`, add a new private network interface with the same Network name as chosen previously. I.e., all VMs with an adapter on internal network `<blah>` will be able to see other VMs with an adapter for `<blah>`
- Next, install VirtualBox Guest additions. Please follow the directions here https://docs.oracle.com/cd/E36500_01/E36502/html/qs-guest-additions.html 

- Now create a shared folder on your Host VM (I called mine `sharevm`)
- Go to shared folders and click the folder with a green plus to`sharevm`  as a shared folder. Copy the install scripts in ../lab_setup/Windows* into the shared folder
	- Alternatively, use VBoxManage 
	
```bash
VBoxManage sharedfolder add "WindowsSandbox" --name sharevm -hostpath /home/user/sharevm -readonly -automount
```
 with the command modified based on your system. see https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/vboxmanage-sharedfolder.html for more.
 
From there, copy the install scripts over to your new Windows VM. Run them in the following order: 
- First, Make sure you have internet `ping 1.1.1.1`
- 	
- ![[Network_addapters.png]]
- Second, install Boxstarter by running from an elevated shell  `box.ps1` 
	- to get an elevated shell, right click powershell.exe and run as admin
- Then from a Boxstarter shell, run the following scripts in order:
	-  `tools.ps1`  to install all of the necessary tools for the sandbox
	
	The setup scripts should have created a new local admin account named Ronald Fillabuster (A great fake name) with a very secure password `P@ssw0rd!`
- Switch to this new local admin account.
	-  Run `network.ps1` to fix a static IP for the Sandbox VM, and to position `Gateway` as the default gateway and default DNS. 
		-  If you are unsure how to run a powershell script from a command prompt, see https://lmgtfy.app/?q=how+to+run+a+powershell+script+from+command+line :-)
	    -  If you get an error about the execution policy...Google it :D 
	-  Feel free to customize tools.ps1. I would also advise you to read the contents of the script! 
- Optionally, update your Windows VM.


 Now that all of the tools needed for the course are installed, it is important to disconnect the sandbox from the internet. To do this, disable  the first network adapter. On my device,  this entails disabling the NAT interface on the sandbox VM by clicking the bottom right network icon,  and unchecking the first entry. If you need more tools or need to update, enable the first interface again. Once this is done, **TAKE A SNAPSHOT**
	 VMs are notoriously unstable. **TAKE A SNAPSHOT**.  If you do not **TAKE A SNAPSHOT** and you're VM stops working, you might have to repeat all of the previous steps. So  please, **TAKE A SNAPSHOT**. Did I mention that you should **TAKE A SNAPSHOT**? 
	
![[snapshot.png]]
	



- Test your connection by trying to ping Gateway `ping 10.10.10.2`
- Make sure you can't reach google: `ping 8.8.8.8` and more generally make sure you VM is cut off from the internet. 
	- If you try pinging  a Domain and the response time is `<1ms`, this probably not a problem (think about why :-) ) 


## Windows Development
Repeat the same steps above, but **omit** the following steps: 
- Second network adapter
- `network.ps1`

Once all of the tools are installed, create a shared folder to perform development on the host OS and share it with the guest. 
Once setup, **TAKE A SNAPSHOT** 

# Setup Flag
- Now that your vms are setup, create a shared folder on your Remnux box, and host a simple python server with `python3 -m http.server --bind 10.10.10.2 --directory /tmp/jail/ 1234
` to host a static file server on port 1337. To download files, simply visit `http://10.10.10.2:1337/` and download files there. Note this server will server will serve files from whatever directory you run the 
- If you do directly mount the folder on your guest Windows vm, make sure that it is read only! Think about what happens if the malware you detonate is ransomware 
- To add a shared folder, select your VM and click settings
- Go to shared folders and add one
- ![[shared_folder.png]]
- Now copy `hw0.exe` over to your windows machine.  Do not ever enable drag and drop on your Windows sandbox.
- You should have inetsim running on your Remnux instance configured as described above.
- Open a terminal and run `sudo wireshark`
	- Select the network interface associated with your private network  (`enp0s8/eth1...etc`)
- now on the windows machine, run `hw0.exe`  and wait for execution to terminate. 
- Once the program exits, stop wireshark capture by clicking the shark fin icon in the top left corner.
![[wireshark1.png]]
- Scroll down on the TCP traffic and look for packets that contain the pattern `FLAG{`
![[flag.png]]
- Once found, right click the packet and select `follow-->follow tcp stream`
![[follow_tcp.png]]
- Inside of this window, there should be a flag! submit this to the CTF.
![[flag2.png]]
- For those of you with some reverse engineering experience, you probably shouldn't waist  your time trying to  reverse the binary since it is protected with military grade encryption.  


# Connecting to Sandbox Via Gateway Over SSH

Here is a sample SSH config file that can be used to tunnel an ssh connection first through the Gateway, then to the Windows host
```ssh
Host gateway
  HostName 127.0.0.1
  User vagrant
  Port 2222
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /path/to/private/key
  IdentitiesOnly yes
  LogLevel FATAL

Host sandbox
  HostName 10.10.10.3
  User vagrant
  Port 22
  UserKnownHostsFile /dev/null
  StrictHostKeyChecking no
  PasswordAuthentication no
  IdentityFile /path/to/other/private/key
  IdentitiesOnly yes
  LogLevel FATAL
  ProxyJump gateway

```



# Vagrant Setup
- If you opt to use Vagrant to setup your environment, open a terminal in the UbuntuServer directory. 
Run `vagrant up  --provision`

- Once it finishes, you should have your Gateway VM. You should expect installation to take 1-2 hours depending on your network connection. 
- To monitor progress, open up Virtualbox and select `show` on the new VM
- Once installed, you can run `vagrant up`  followed by `vagrant ssh `

# Windows
- Run `vagrant up`
- This will take a bit to download and setup the windows VM. You will probably see an error on the Virtualbox GUI. Click ignore, and restart once it finishes. 
- Try running `vagrant up` followed by `vagrant ssh`
- If everything works, run `vagrant up --provision`
- Warning: I read through the packer script used to create the 3rd party windows Vagrant box, but I make no guarantees that it isn't backdoored in some way.   Use at your own risk. :-)

	
	For a more involved setup using KVM, see
	https://c3rb3ru5d3d53c.github.io/documents/kvm-malware-lab/
	
	