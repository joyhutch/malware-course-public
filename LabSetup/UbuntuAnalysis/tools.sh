#!/bin/bash

GHIDRA_SHA256=f1f240f91cf6b1dffc9a4148384ee3c6b269a8ae27c6f981577973e00043ad94
GHIDRA_RELEASE=https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.0_build/ghidra_11.0_PUBLIC_20231222.zip
GHIDRA_VERSION=11.0
GHIDRATHON=https://github.com/mandiant/Ghidrathon/archive/refs/tags/v3.0.2.zip
GHIDRATHON_VERSION=3.0.2

PE_BEAR_RELEASE=https://github.com/hasherezade/pe-bear/releases/download/v0.6.7.3/PE-bear_0.6.7.3_qt5.15_x64_linux.tar.xz

GRADLE_VERSION=8.5

# install compiler, gpg, other utilities 
sudo apt-get install -y build-essential mingw-w64 gpg wget zsh git curl tmux  unzip 
sudo apt-get install -y nasm

# install text editor/ide
sudo apt-get install -y vim 

# install vscode 
wget -O- https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --dearmor | sudo tee /usr/share/keyrings/vscode.gpg
echo deb [arch=amd64 signed-by=/usr/share/keyrings/vscode.gpg] https://packages.microsoft.com/repos/vscode stable main | sudo tee /etc/apt/sources.list.d/vscode.list
sudo apt-get update
sudo apt-get install -y code


# install analysis tools 
sudo apt-get install -y  mitmproxy socat

# https://unix.stackexchange.com/questions/367866/how-to-choose-a-response-for-interactive-prompt-during-installation-from-a-shell/413011#413011
echo "wireshark-common wireshark-common/install-setuid boolean true" | sudo debconf-set-selections
sudo DEBIAN_FRONTEND=noninteractive apt-get -y install wireshark


## install inetsim
echo "deb http://www.inetsim.org/debian/ binary/" > /etc/apt/sources.list.d/inetsim.list
echo "deb-src http://www.inetsim.org/debian/ source/" >> /etc/apt/sources.list.d/inetsim.list

wget -O - https://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add -
sudo apt-get update
sudo apt-get install -y inetsim 


# we want to control when this gets run 
sudo systemctl disable inetsim 

# PE-bear
wget https://github.com/hasherezade/pe-bear/releases/download/v0.6.1/PE-bear_0.6.1_qt5.14_x64_linux.tar.xz
wget $PE_BEAR_RELEASE -O /tmp/pebear.tar.xz
tar xfv /tmp/pebear.tar.xz
sudo mv /tmp/PE-bear /usr/local/bin/

## Cleanup artifacts
rm capstone_LICENSE.TXT

# install python 
sudo apt-get install -y python3-pip python3-venv

# install ghidra

sudo apt-get install -y openjdk-17-jdk openjdk-17-jre
GHIDRA_OUT="$HOME/ghidra_$GHIDRA_VERSION.zip"
GHIDRA_DIR="$HOME/ghidra_${GHIDRA_VERSION}_PUBLIC"
wget $GHIDRA_RELEASE -O $GHIDRA_OUT
HASH=$( sha256sum $GHIDRA_OUT| awk '{ print $1 }')

unzip $GHIDRA_OUT

export GHIDRA_RUN=$GHIDRA_DIR/ghidraRun
chmod +x  $GHIDRA_RUN

echo "export PATH=\$PATH:$(pwd)/ghidra_10.2.2_PUBLIC/" >> ~/.bashrc

## install ghidrathon
#sudo add-apt-repository -y  ppa:cwchien/gradle
#sudo apt-get install -y gradle 
#git clone https://github.com/mandiant/Ghidrathon.git


wget https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip -P /tmp 
sudo unzip -d /opt/gradle /tmp/gradle-${GRADLE_VERSION}-bin.zip
sudo ln -s /opt/gradle/gradle-${GRADLE_VERSION} /opt/gradle/latest
export GRADLE_HOME=/opt/gradle/latest
export PATH=${GRADLE_HOME}/bin:${PATH}


wget $GHIDRATHON -O ghidrathon.zip 
unzip ghidrathon.zip
### create virtual env 
python3 -m venv ghidra_env

### activate env
source ghidra_env/bin/activate

cd "$HOME/Ghidrathon-$GHIDRATHON_VERSION"

gradle -PGHIDRA_INSTALL_DIR="$HOME/ghidra_${GHIDRA_VERSION}_PUBLIC"
cd $HOME
cp $HOME/Ghidrathon-$GHIDRATHON_VERSION/dist/*.zip $GHIDRA_DIR/Extensions/Ghidra/


# Tools from Remnux that are handy 
wget https://raw.githubusercontent.com/REMnux/distro/master/files/mynic
chmod +x mynic
sudo mv mynic /usr/local/bin 


wget https://raw.githubusercontent.com/REMnux/distro/master/files/accept-all-ips
chmod +x accept-all-ips
sudo mv accept-all-ips /usr/local/bin/

# tor ,  wireguard 
sudo apt-get install -y tor  
