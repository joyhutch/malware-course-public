#include <stdio.h>
#include <windows.h>

int main(int argc, char **argv) {
  HANDLE hReadPipe, hWritePipe;
  SECURITY_ATTRIBUTES saAttr;
  char buffer[512];
  DWORD written, read;
  STARTUPINFO si;
  PROCESS_INFORMATION pi;

  char message[] = "Hello from parent!";
  if (argc != 2) {
    printf("usage: %s child_process\n", argv[0]);
    return 1;
  }
  // Set the bInheritHandle flag so pipe handles are inherited.
  saAttr.nLength = sizeof(SECURITY_ATTRIBUTES);
  saAttr.bInheritHandle = TRUE;
  saAttr.lpSecurityDescriptor = NULL;

  // Create a pipe for the child process's STDOUT.
  if (!CreatePipe(&hReadPipe, &hWritePipe, &saAttr, 0)) {
    fprintf(stderr, "CreatePipe failed (%d)\n", GetLastError());
    return 1;
  }

  // Set up members of the PROCESS_INFORMATION structure.
  ZeroMemory(&pi, sizeof(PROCESS_INFORMATION));

  // Set up members of the STARTUPINFO structure.
  // This structure specifies the STDIN and STDOUT handles for redirection.
  ZeroMemory(&si, sizeof(STARTUPINFO));
  si.cb = sizeof(STARTUPINFO);
  si.hStdError = hWritePipe;
  si.hStdOutput = hWritePipe;
  si.dwFlags |= STARTF_USESTDHANDLES;

  // Create the child process.
  if (!CreateProcessA(NULL,
                      argv[1], // The command line for the child process
                      NULL,    // Process handle not inheritable
                      NULL,    // Thread handle not inheritable
                      TRUE,    // Set handle inheritance to TRUE
                      0,       // No creation flags
                      NULL,    // Use parent's environment block
                      NULL,    // Use parent's starting directory
                      &si,     // Pointer to STARTUPINFO structure
                      &pi)     // Pointer to PROCESS_INFORMATION structure
  ) {
    fprintf(stderr, "CreateProcess failed (%d).\n", GetLastError());
    return 1;
  }

  // Write to the pipe that is the standard input for a child process.
  WriteFile(hWritePipe, message, strlen(message), &written, NULL);

  // Close the write end of the pipe before reading from the read end of the
  // pipe.
  CloseHandle(hWritePipe);

  // Read output from the child process's pipe for STDOUT
  // and print to the parent process's STDOUT.
  if (ReadFile(hReadPipe, buffer, sizeof(buffer), &read, NULL)) {
    printf("Received message from child: %.*s\n", read, buffer);
  }

  // Close the handles once done.
  CloseHandle(hReadPipe);
  CloseHandle(pi.hProcess);
  CloseHandle(pi.hThread);

  return 0;
}
