// #define _WIN32_WINNT 0x0601

#include <stdio.h>
#include <winsock2.h>
#include <ws2tcpip.h>

#include <windows.h>

#define PORT 8080
#define SERVER_ADDR "127.0.0.1"

// https://stackoverflow.com/questions/15660203/inet-pton-identifier-not-found
int inet_pton(int af, const char *src, void *dst) {
  struct sockaddr_storage ss;
  int size = sizeof(ss);
  char src_copy[INET6_ADDRSTRLEN + 1];

  ZeroMemory(&ss, sizeof(ss));
  /* stupid non-const API */
  strncpy(src_copy, src, INET6_ADDRSTRLEN + 1);
  src_copy[INET6_ADDRSTRLEN] = 0;

  if (WSAStringToAddress(src_copy, af, NULL, (struct sockaddr *)&ss, &size) ==
      0) {
    switch (af) {
    case AF_INET:
      *(struct in_addr *)dst = ((struct sockaddr_in *)&ss)->sin_addr;
      return 1;
    case AF_INET6:
      *(struct in6_addr *)dst = ((struct sockaddr_in6 *)&ss)->sin6_addr;
      return 1;
    }
  }
  return 0;
}

const char *inet_ntop(int af, const void *src, char *dst, socklen_t size) {
  struct sockaddr_storage ss;
  unsigned long s = size;

  ZeroMemory(&ss, sizeof(ss));
  ss.ss_family = af;

  switch (af) {
  case AF_INET:
    ((struct sockaddr_in *)&ss)->sin_addr = *(struct in_addr *)src;
    break;
  case AF_INET6:
    ((struct sockaddr_in6 *)&ss)->sin6_addr = *(struct in6_addr *)src;
    break;
  default:
    return NULL;
  }
  /* cannot direclty use &size because of strict aliasing rules */
  return (WSAAddressToString((struct sockaddr *)&ss, sizeof(ss), NULL, dst,
                             &s) == 0)
             ? dst
             : NULL;
}

int main() {
  WSADATA wsa;
  SOCKET client_socket;
  struct sockaddr_in server;
  char buffer[1024] = {0};

  // Initialize Winsock
  if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0) {
    printf("WSAStartup failed\n");
    return 1;
  }

  // Create socket
  if ((client_socket = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET) {
    printf("Socket creation failed\n");
    return 1;
  }

  server.sin_family = AF_INET;
  server.sin_port = htons(PORT);

  // Convert IPv4 address from text to binary form
  if (inet_pton(AF_INET, SERVER_ADDR, &server.sin_addr) <= 0) {
    printf("Invalid address/ Address not supported\n");
    return 1;
  }

  // Connect to server
  if (connect(client_socket, (struct sockaddr *)&server, sizeof(server)) < 0) {
    printf("Connection failed\n");
    return 1;
  }

  // Receive message from server
  recv(client_socket, buffer, sizeof(buffer), 0);
  printf("Message received from server: %s\n", buffer);

  // Close socket and cleanup
  closesocket(client_socket);
  WSACleanup();

  return 0;
}
