#include <stdio.h>
#include <winsock2.h>
#include <ws2tcpip.h>

#include <windows.h>
#define PORT 8080

int main() {
  WSADATA wsa;
  SOCKET server_socket, client_socket;
  struct sockaddr_in server, client;
  int client_len;
  char buffer[1024] = {0};
  const char *message = "Hello from server process!";

  // Initialize Winsock
  if (WSAStartup(MAKEWORD(2, 2), &wsa) != 0) {
    printf("WSAStartup failed\n");
    return 1;
  }

  // Create socket
  if ((server_socket = socket(AF_INET, SOCK_STREAM, 0)) == INVALID_SOCKET) {
    printf("Socket creation failed\n");
    return 1;
  }

  server.sin_family = AF_INET;
  server.sin_addr.s_addr = INADDR_ANY;
  server.sin_port = htons(PORT);

  // Bind
  if (bind(server_socket, (struct sockaddr *)&server, sizeof(server)) ==
      SOCKET_ERROR) {
    printf("Bind failed\n");
    closesocket(server_socket);
    return 1;
  }

  // Listen
  if (listen(server_socket, 3) == SOCKET_ERROR) {
    printf("Listen failed\n");
    closesocket(server_socket);
    return 1;
  }

  printf("Server listening on port %d\n", PORT);

  // Accept incoming connection
  client_len = sizeof(client);
  if ((client_socket = accept(server_socket, (struct sockaddr *)&client,
                              &client_len)) == INVALID_SOCKET) {
    printf("Accept failed\n");
    closesocket(server_socket);
    return 1;
  }

  // Send message to client
  send(client_socket, message, strlen(message), 0);
  printf("Message sent from server: %s\n", message);

  // Close sockets and cleanup
  closesocket(client_socket);
  closesocket(server_socket);
  WSACleanup();

  return 0;
}
