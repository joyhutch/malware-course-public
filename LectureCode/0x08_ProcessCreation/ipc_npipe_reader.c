#include <stdio.h>
#include <windows.h>

int main(void) {
  HANDLE hPipe;
  char buffer[1024];
  DWORD dwRead, dwWritten;

  hPipe = CreateNamedPipeA("\\\\.\\pipe\\MyPipe", PIPE_ACCESS_DUPLEX,
                           PIPE_TYPE_BYTE | PIPE_READMODE_BYTE | PIPE_WAIT,
                           PIPE_UNLIMITED_INSTANCES, 1024, 1024,
                           NMPWAIT_USE_DEFAULT_WAIT, NULL);

  if (hPipe == INVALID_HANDLE_VALUE) {
    fprintf(stderr, "CreateNamedPipe failed, GLE=%d.\n", GetLastError());
    return -1;
  }

  printf("Waiting for client connection...\n");

  if (ConnectNamedPipe(hPipe, NULL) != FALSE) {
    while (ReadFile(hPipe, buffer, sizeof(buffer) - 1, &dwRead, NULL) !=
           FALSE) {
      printf("Received: %s\n", buffer);

      // Send a response to the client.
      char *response = "Hello from server!";
      WriteFile(hPipe, response, strlen(response), &dwWritten, NULL);
    }
  }

  CloseHandle(hPipe);

  return 0;
}
