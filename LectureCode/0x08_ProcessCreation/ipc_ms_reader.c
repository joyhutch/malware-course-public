#include <stdio.h>
#include <windows.h>

int main(void) {
  HANDLE hMailslot;
  DWORD bytesRead;
  char messageBuffer[256];
  BOOL readResult;

  // Create a mailslot with the name "\\.\mailslot\sample_mailslot".
  hMailslot =
      CreateMailslotA("\\\\.\\mailslot\\sample_mailslot",
                      0,                     // No maximum message size
                      MAILSLOT_WAIT_FOREVER, // No time-out for operations
                      NULL);                 // Default security attributes

  if (hMailslot == INVALID_HANDLE_VALUE) {
    printf("CreateMailslot failed with %d\n", GetLastError());
    return 1;
  }

  printf("Mailslot created and waiting for messages...\n");

  // Continuously read messages sent to the mailslot.
  while (TRUE) {
    readResult = ReadFile(hMailslot,
                          messageBuffer,         // Buffer to receive data
                          sizeof(messageBuffer), // Size of buffer
                          &bytesRead,            // Number of bytes read
                          NULL);                 // Not overlapped I/O

    if (!readResult) {
      printf("ReadFile failed with %d\n", GetLastError());
      break;
    }

    if (bytesRead > 0) {
      messageBuffer[bytesRead / sizeof(char)] =
          '\0'; // Null terminate the string
      printf("Message received: %s\n", messageBuffer);
    }
  }

  CloseHandle(hMailslot);
  return 0;
}
